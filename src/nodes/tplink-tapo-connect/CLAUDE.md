# Claude Code 高品質ソフトウェア開発指示書

## 概要

この指示書は、Rust実装のTP-Link Tapoデバイス制御ライブラリ（<https://github.com/mihai-dinculescu/tapo.git）をNode.jsに移植するものです。>
また、この指示書はClaude Codeを使用してソフトウェア開発の品質を向上させるためのガイドラインです。コードの保守性、可読性、安全性、そして効率性を最大化することを目的としています。

## 移植に関わる重要な制約事項

- **インターフェース保持**: 既存の`tplink-tapo-connect-wrapper.ts`の関数のI/Fのみ変更不可、追加は自由に行ってもよい
- **互換性維持**: ラッパー経由で接続される既存アプリケーションの動作を保証する必要がある

### 1. 技術スタック

#### 1. 移植元（Rust実装）

- **リポジトリ**: <https://github.com/mihai-dinculescu/tapo.git>
- **言語**: Rust
- **主要機能**:
  - Tapoデバイスの認証とセッション管理
  - デバイス制御（電源ON/OFF、明るさ調整など）
  - デバイス情報の取得
  - エネルギー使用量のモニタリング

#### 2. 移植先（Node.js実装）

- **言語**: TypeScript/JavaScript
- **ランタイム**: Node.js
- **インターフェース層**: `tplink-tapo-connect-wrapper.ts`

### 2. アーキテクチャ構成

```txt
既存アプリケーション
        ↓
tplink-tapo-connect-wrapper.ts （関数のI/Fのみ変更不可、追加は自由に行ってもよい）
        ↓
Node.js Tapo実装（本プロジェクトで開発）
        ↓
Tapoデバイス（TP-Link製品）
```

### 3. 移植における重要ポイント

#### 1. 認証メカニズム

- Rust実装の認証フローを正確に再現
- クッキーとトークンの管理
- セッションの有効期限処理

#### 2. 暗号化通信

- AES暗号化の実装
- RSA鍵交換の処理
- ペイロードの暗号化/復号化

#### 3. プロトコル実装

- HTTP/HTTPSリクエストの処理
- JSONペイロードの構築
- エラーハンドリング

#### 4. 非同期処理

- Rustのasync/awaitパターンをNode.jsのPromise/async-awaitに変換
- 並行処理の適切な実装

### 4. ラッパーインターフェース仕様

`tplink-tapo-connect-wrapper.ts`が期待する主要なインターフェース：

```typescript
// 例（実際のインターフェースは既存実装を確認すること）
interface TapoDevice {
  connect(email: string, password: string): Promise<void>;
  getDeviceInfo(): Promise<DeviceInfo>;
  setPowerState(on: boolean): Promise<void>;
  // ... その他のメソッド
}
```

## 基本原則

### 1. コード品質の基準

- **可読性**: コードは他の開発者が容易に理解できる形で記述する
- **保守性**: 将来の変更や拡張に対応しやすい構造にする
- **再利用性**: 同様の機能を他の場所でも使用できるように設計する
- **テスタビリティ**: ユニットテストやインテグレーションテストが書きやすい構造にする

### 2. セキュリティ重視

- 入力値の検証とサニタイゼーションを必ず実装
- 機密情報の適切な取り扱い
- 最新のセキュリティベストプラクティスの適用

## Claude Codeを使用した開発フロー

### Phase 1: 要件分析と設計

```
Claude Code実行例:
$ claude code "プロジェクトの要件を分析し、アーキテクチャ設計書を作成してください"
```

**実行内容:**

- 機能要件と非機能要件の明確化
- システムアーキテクチャの設計
- データベース設計
- API設計書の作成

### Phase 2: 開発環境のセットアップ

```
claude code "開発環境のセットアップスクリプトを作成し、依存関係を管理してください"
```

**実行内容:**

- 開発環境の自動化スクリプト作成
- 依存関係管理ファイルの作成
- Docker環境の構築
- CI/CDパイプラインの基盤作成

### Phase 3: コア機能の実装

```
claude code "〇〇機能を実装してください。テストケースも含めて作成してください"
```

**実行内容:**

- 機能の段階的実装
- 単体テストの同時作成
- エラーハンドリングの実装
- ログ機能の実装

### Phase 4: コードレビューと最適化

```
claude code "コードレビューを実施し、パフォーマンスとセキュリティの観点から最適化してください"
```

**実行内容:**

- コード品質チェック
- セキュリティ脆弱性の検査
- パフォーマンスの最適化
- ドキュメントの更新

## コーディング規約

### 命名規則

- **関数名**: 動詞から始まる明確な名前（例: `calculateTotalPrice`, `validateUserInput`）
- **変数名**: 用途が明確にわかる名前（例: `userEmail`, `orderItems`）
- **定数**: 大文字のスネークケース（例: `MAX_RETRY_COUNT`, `API_ENDPOINT`）

### コメントとドキュメント

```javascript
/**
 * ユーザーの注文合計金額を計算する
 * @param {Array} items - 注文アイテムの配列
 * @param {number} taxRate - 税率（0.1 = 10%）
 * @returns {number} 税込み合計金額
 * @throws {Error} アイテムが空の場合
 */
function calculateOrderTotal(items, taxRate) {
    // 実装
}
```

### エラーハンドリング

- すべての関数で適切な例外処理を実装
- ユーザーフレンドリーなエラーメッセージ
- ログレベルの適切な設定

## テスト戦略

### 1. ユニットテスト

```
claude code "〇〇関数のユニットテストを作成してください。境界値テストとエラーケースも含めて"
```

**要件:**

- 関数の正常系テスト
- 境界値テスト
- 異常系テスト
- カバレッジ80%以上を目標

### 2. インテグレーションテスト

```
claude code "APIエンドポイントのインテグレーションテストを作成してください"
```

**要件:**

- API間の連携テスト
- データベース連携テスト
- 外部サービス連携テスト

### 3. E2Eテスト

```
claude code "ユーザージャーニーのE2Eテストを作成してください"
```

## セキュリティチェックリスト

### 入力検証

- [ ] 全ての入力値に対するバリデーション
- [ ] SQLインジェクション対策
- [ ] XSS攻撃対策
- [ ] CSRF攻撃対策

### 認証・認可

- [ ] 適切な認証メカニズム
- [ ] ロールベースアクセス制御
- [ ] セッション管理
- [ ] パスワードの安全な保存

### データ保護

- [ ] 機密データの暗号化
- [ ] 通信の暗号化（HTTPS）
- [ ] ログでの機密情報マスキング

## パフォーマンス最適化

### データベース最適化

```
claude code "データベースクエリを最適化し、インデックスを追加してください"
```

### キャッシュ戦略

```
claude code "効果的なキャッシュ戦略を実装してください"
```

### コード最適化

```
claude code "パフォーマンスボトルネックを特定し、最適化してください"
```

## CI/CD実装

### 自動化パイプライン

```
claude code "CI/CDパイプラインを構築してください。テスト、セキュリティチェック、デプロイメントを含めて"
```

**含むべき要素:**

- 自動テスト実行
- コード品質チェック
- セキュリティスキャン
- 自動デプロイメント
- ロールバック機能

## モニタリングとログ

### ログ戦略

```bash
claude code "包括的なログ機能を実装してください。構造化ログとエラートラッキングを含めて"
```

### メトリクス収集

- アプリケーションパフォーマンス
- エラー率
- レスポンス時間
- リソース使用量

## 継続的改善

### コードレビュープロセス

1. プルリクエスト作成
2. Claude Codeによる自動チェック
3. 人手によるレビュー
4. 修正とマージ

### リファクタリング指針

```bash
claude code "レガシーコードをリファクタリングしてください。段階的な移行計画も含めて"
```

## プロジェクト完了時のチェックリスト

### ドキュメント

- [ ] API仕様書
- [ ] 運用手順書
- [ ] トラブルシューティングガイド
- [ ] ユーザーマニュアル

### 品質保証

- [ ] 全テストの実行
- [ ] セキュリティ監査完了
- [ ] パフォーマンステスト完了
- [ ] 負荷テスト完了

### デプロイメント準備

- [ ] 本番環境設定
- [ ] バックアップ戦略
- [ ] ロールバック計画
- [ ] 監視設定

## Claude Code活用のベストプラクティス

### 効果的なプロンプト作成

- 具体的で明確な指示
- 期待する成果物の明示
- 制約条件や要件の詳細化

### 段階的開発

- 小さな機能単位での実装
- 定期的なレビューとフィードバック
- 継続的な品質改善

### 学習と改善

- Claude Codeからの提案を積極的に学習
- チーム内での知識共有
- 新しいベストプラクティスの採用

---

## 本プロジェクト開発の指示

 プロジェクト概要

家電デバイスである「TPLINK TAPO」を、ローカルかつプログラムから制御するためのシステムを開発したい。
このシステムは、現時点アクティブな「移植元のプロジェクト」を参照し、新しく「TypeScript Node.js」に移植することを目的とする。

### 移植対象機能

#### 1. 移植元のプロジェクト

[mihai-dinculescu/tapo](https://github.com/mihai-dinculescu/tapo)

#### 2. 現在未実装の重要機能

##### a) 追加デバイス制御機能

- **色温度制御**: `setColorTemperature()` - 電球デバイスの色温度調整
- **ライト効果**: `setLightEffect()` - 動的ライト効果の設定
- **カラー制御の拡張**: HSV、RGB、色名による色指定
- **デバイス状態の詳細取得**: 現在の設定値、制御可能な範囲情報

##### b) 新規デバイス型のサポート

- **Light Bulbs** (L510, L520, L610, L530, L535, L630): スマート調光電球
- **Light Strips** (L900, L920, L930): ライトストリップ制御
<!-- - **Hubs** (H100): ハブデバイス制御 -->
<!-- - **Switches** (S200B): スイッチデバイス制御 -->
<!-- - **Sensors** (KE100, T100, T110, T300, T310, T315): 各種センサー制御 -->
<!-- - **T105**: モーションセンサー（現在mihai-dinculescu/tapoライブラリでは未サポート） -->
- **Plugs** (P100, P105, P110, P115, P300, P304): 電源タップ制御

###### Device support

デバイスサポートと機能

&#x2705; - Support

| Feature<br/><br/><br/>               | GenericDevice<br/><br/><br/> | L510<br/>L520<br/>L610 | L530<br/>L535<br/>L630<br/> | L900<br/><br/><br/> | L920<br/>L930<br/><br/> | P100<br/>P105<br/><br/> | P110<br/>P115<br/><br/> | P300<br/>P304<br/><br/> | H100<br/><br/><br/> |
| ------------------------------------ | :--------------------------: | :--------------------: | :-------------------------: | :-----------------: | :---------------------: | :---------------------: | :---------------------: | :---------------------: | :-----------------: |
| device_reset                         |                              |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |                         |                     |
| get_child_device_component_list_json |                              |                        |                             |                     |                         |                         |                         |        &#x2705;         |      &#x2705;       |
| get_child_device_list                |                              |                        |                             |                     |                         |                         |                         |        &#x2705;         |      &#x2705;       |
| get_child_device_list_json           |                              |                        |                             |                     |                         |                         |                         |        &#x2705;         |      &#x2705;       |
| get_current_power                    |                              |                        |                             |                     |                         |                         |        &#x2705;         |                         |                     |
| get_device_info                      |           &#x2705;           |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |        &#x2705;         |      &#x2705;       |
| get_device_info_json                 |           &#x2705;           |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |        &#x2705;         |      &#x2705;       |
| get_device_usage                     |                              |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |                         |                     |
| get_energy_data                      |                              |                        |                             |                     |                         |                         |        &#x2705;         |                         |                     |
| get_energy_usage                     |                              |                        |                             |                     |                         |                         |        &#x2705;         |                         |                     |
| get_supported_ringtone_list          |                              |                        |                             |                     |                         |                         |                         |                         |      &#x2705;       |
| off                                  |           &#x2705;           |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |                         |                     |
| on                                   |           &#x2705;           |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |                         |                     |
| play_alarm                           |                              |                        |                             |                     |                         |                         |                         |                         |      &#x2705;       |
| refresh_session                      |           &#x2705;           |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |        &#x2705;         |        &#x2705;         |        &#x2705;         |      &#x2705;       |
| set_brightness                       |                              |        &#x2705;        |          &#x2705;           |      &#x2705;       |        &#x2705;         |                         |                         |                         |                     |
| set_color                            |                              |                        |          &#x2705;           |      &#x2705;       |        &#x2705;         |                         |                         |                         |                     |
| set_color_temperature                |                              |                        |          &#x2705;           |      &#x2705;       |        &#x2705;         |                         |                         |                         |                     |
| set_hue_saturation                   |                              |                        |          &#x2705;           |      &#x2705;       |        &#x2705;         |                         |                         |                         |                     |
| set_lighting_effect                  |                              |                        |                             |                     |        &#x2705;         |                         |                         |                         |                     |
| set() API \*                         |                              |                        |          &#x2705;           |      &#x2705;       |        &#x2705;         |                         |                         |                         |                     |
| stop_alarm                           |                              |                        |                             |                     |                         |                         |                         |                         |      &#x2705;       |

### 2. 移植優先度

**高優先度**:

1. 旧APIと新API(KLAP V1/V2)のサポート
2. プラグ制御機能
3. 電力モニタ機能

**中優先度**:

1. ライト制御機能
2. 色温度制御機能
3. 新規デバイス型サポート

**低優先度**:

1. 全API実装
2. 高度な設定機能
3. バッチ操作機能

## 現在のコードベース構造分析

### 既存実装状況

- **基本制御**: ON/OFF、明度、色指定 ✅
- **デバイス情報取得**: 基本情報、エネルギー使用量 ✅
- **認証**: クラウドログイン、デバイス直接接続 ✅
- **プロトコル**: KLAP、Secure Passthrough ✅

### ラッパー構造

`tplink_tapo_connect_wrapper.ts` は以下の機能を提供:

- シングルトンパターンでの実装
- エイリアス名によるデバイス検索
- 統一されたエラーハンドリング
- 結果オブジェクトの標準化

## 実装ガイドライン

### 1. コード品質基準

- **型安全性**: すべての新機能に適切な TypeScript 型定義
- **エラーハンドリング**: 統一されたエラー処理パターン
- **テスト**: 新機能には対応する単体テスト実装
- **ドキュメント**: JSDoc コメントによる API ドキュメント

### 2. 既存パターンの踏襲

- **認証フロー**: 既存の `cloudLogin()` および `loginDeviceByIp()` パターン
- **プロトコル実装**: 既存の KLAP/Secure Passthrough フォールバック
- **ラッパー設計**: 既存のシングルトンパターンと結果オブジェクト構造

### 3. Python版との互換性

- **API設計**: 可能な限り Python版と同等の API インターフェース
- **パラメータ**: 同じパラメータ名と値の範囲
- **戻り値**: 同等の情報を含む結果オブジェクト

### 4. 移植手順

1. **Python版コードの詳細分析**
   - 対象機能の動作仕様を理解
   - 必要なパラメータとレスポンス形式を特定

2. **TypeScript版実装**
   - `src/types/`: 必要な型定義を追加
   - `src/devices/`: デバイス固有メソッド実装
   - `src/core/`: プロトコル層での通信処理実装

3. **デバイスクラス実装**
   - `src/devices/`: 新デバイス対応クラス追加
   - エラーハンドリング統一
   - 結果オブジェクト形式の標準化

### 重要ファイル

- `src/types/`: 型定義（base.ts, sensors.ts等）
- `src/index.ts`: メインエントリポイント
- `src/devices/`: デバイス制御インターフェース
- `src/core/`: 認証・通信基盤
- `examples/`: 使用例・サンプルコード
