
# tplink-tapo-connect 設計ドキュメント

## 1. 概要

このドキュメントは、`tplink-tapo-connect`ライブラリの設計思想、アーキテクチャ、および主要コンポーネントについて記述します。本ライブラリは、TP-Link Tapoシリーズのスマートホームデバイス（スマートプラグ、スマート電球など）をプログラムから制御するためのNode.js向け非公式ライブラリです。

主な目的は、以下の通りです。

*   **安定性と信頼性:** 異なるデバイスモデルやファームウェアバージョン間での安定した通信を実現します。
*   **拡張性:** 新しいデバイスモデルや機能の追加を容易にするための柔軟なアーキテクチャを提供します。
*   **使いやすさ:** シンプルで直感的なAPIを提供し、開発者が容易にTapoデバイスを制御できるようにします。
*   **保守性:** 関心の分離（SoC）原則に基づき、各コンポーネントが単一の責任を持つように設計し、コードの保守性を高めます。

## 2. アーキテクチャ

本ライブラリは、**コンポジション（Composition）パターン**と**関心の分離（Separation of Concerns）**を中核とした階層的なアーキテクチャを採用しています。これにより、各コンポーネントが特定の役割に集中し、コードの再利用性と保守性が向上します。

アーキテクチャは、以下の主要なレイヤーで構成されています。

1.  **ラッパー/サービスレイヤー (Wrapper/Service Layer):** エンドユーザーが直接利用する最上位レイヤー。シンプルなインターフェースを提供し、複雑な内部処理をカプセル化します。
2.  **デバイスレイヤー (Device Layer):** デバイスの種類（プラグ、電球）ごとの具体的な振る舞いを定義します。
3.  **コントローラーレイヤー (Controller Layer):** デバイスの機能（電源制御、エネルギー監視、照明制御など）ごとのロジックを実装します。
4.  **コアレイヤー (Core Layer):** 通信プロトコル、認証、セッション管理、暗号化など、低レベルの通信処理を担当します。
5.  **ユーティリティレイヤー (Utility Layer):** エラー処理、リトライ処理など、ライブラリ全体で利用される共通機能を提供します。
6.  **型定義レイヤー (Types Layer):** TypeScriptの型定義を集約し、コードの安全性と一貫性を保証します。

### アーキテクチャ図

```
+-------------------------------------------------+
|           Wrapper/Service Layer                 |
| (tplink-tapo-connect-wrapper, DeviceControlService) |
+-----------------------+-------------------------+
                        |
+-----------------------+-------------------------+
|                   Device Layer                  |
|      (BaseDevice, PlugDevice, BulbDevice)       |
+-----------------------+-------------------------+
                        |
+-----------------------+-------------------------+
|                 Controller Layer                |
| (DeviceController, EnergyController, LightingController) |
+-----------------------+-------------------------+
                        |
+-----------------------+-------------------------+
|                     Core Layer                  |
| (TapoAuth, KlapAuth, UnifiedTapoProtocol, HttpClient) |
+-------------------------------------------------+
|                  Utility Layer                  |
|           (ErrorClassifier, RetryUtils)         |
+-------------------------------------------------+
|                    Types Layer                  |
|              (TapoDeviceInfo, etc.)             |
+-------------------------------------------------+
```

## 3. 主要コンポーネント

### 3.1. ラッパー/サービスレイヤー

このレイヤーは、ライブラリの公開APIを提供し、エンドユーザーにとっての窓口となります。

*   **`tplink-tapo-connect-wrapper.ts`**:
    *   ライブラリのメインエントリーポイント。
    *   `getTapoDeviceInfo`, `setTapoTurnOn` などの高レベルなAPIを提供します。
    *   内部で `DeviceControlService` を呼び出し、処理を委譲します。
*   **`DeviceControlService.ts`**:
    *   個別のデバイス操作（情報取得、電源ON/OFFなど）をカプセル化します。
    *   `DeviceFactory` を利用して適切なデバイスインスタンスを生成し、操作を実行します。
    *   リトライ処理やエラーハンドリングを統合し、操作の信頼性を高めます。
*   **`BatchOperationService.ts`**:
    *   複数の操作をまとめて実行するためのサービス。
    *   Tapoデバイスで頻発するビジーエラー（`KLAP -1012`）を回避するため、操作間に適切な遅延を挿入するシーケンシャル実行をサポートします。

### 3.2. デバイスレイヤー

このレイヤーは、デバイスのカテゴリ（プラグ、電球）ごとの共通の振る舞いを定義します。

*   **`BaseDevice.ts`**:
    *   すべてのデバイスクラスの基底クラス。
    *   `ConnectionManager`, `SessionManager`, `ProtocolSelector`, `RequestManager` などのコアコンポーネントをコンポジションとして保持します。
    *   `DeviceController` などの機能別コントローラーを保持し、具体的な処理を委譲します。
    *   `connect`, `disconnect` などのデバイスのライフサイクル管理メソッドを定義します。
*   **`PlugDevice.ts`**:
    *   スマートプラグに特化したクラス。`BaseDevice` を継承します。
    *   複数コンセントを持つデバイス（例: P300）の子デバイス制御など、プラグ固有の機能を提供します。
*   **`BulbDevice.ts`**:
    *   スマート電球に特化したクラス。`BaseDevice` を継承します。
    *   ライトエフェクトの設定など、電球固有の機能を提供します。
*   **`GenericDeviceInfoRetriever.ts`**:
    *   デバイスの種類を問わず、基本的なデバイス情報（モデル名など）を軽量に取得するためのクラス。`DeviceFactory` で使用されます。

### 3.3. コントローラーレイヤー

このレイヤーは、デバイスの各機能（電源、エネルギー、照明）に関するロジックをカプセル化します。これにより、機能の追加や修正が容易になります。

*   **`DeviceController.ts`**:
    *   電源ON/OFF、デバイス情報取得、エイリアス設定など、すべてのTapoデバイスに共通する基本的な操作を担当します。
*   **`EnergyController.ts`**:
    *   エネルギー監視機能を持つデバイス（例: P110）の電力使用量取得や統計情報取得を担当します。
    *   `supportsEnergyMonitoring` のような静的メソッドを提供し、特定のデバイスモデルが機能をサポートしているかを判断します。
*   **`LightingController.ts`**:
    *   スマート電球の照明関連機能（輝度、色、色温度、ライトエフェクト）を担当します。
    *   RGBとHSVの相互変換や、名前付きカラーの定義など、色操作に関するユーティリティも提供します。

### 3.4. コアレイヤー

このレイヤーは、Tapoデバイスとの通信における低レベルな処理を担当します。

*   **`TapoAuth.ts`**:
    *   旧来の **Secure Passthrough** プロトコルによる認証処理を実装します。
    *   ハンドシェイク、ログイン、リクエストの暗号化を行います。
*   **`KlapAuth.ts`**:
    *   新しい **KLAP (Kepler Local Access Protocol)** プロトコルによる認証処理を実装します。
    *   **KLAP V1/V2自動判別機能**を搭載し、デバイスのファームウェアバージョンに応じて適切なKLAPバージョンを自動選択します。
    *   **KLAP V2**: 2段階のハンドシェイク（`/app/handshake1` → `/app/handshake2`）とシーケンス番号付きリクエスト（`/app/request`）
    *   **KLAP V1**: 単一ハンドシェイク（`/app/handshake`）とシーケンス番号なしリクエスト（`/app/klap`）
    *   セッションキーの導出、リクエストの暗号化・署名処理はV1/V2共通
*   **`UnifiedTapoProtocol.ts`**:
    *   `TapoAuth` と `KlapAuth` を統合し、単一のインターフェースで両方のプロトコルを扱えるようにします。
    *   接続時に自動でプロトコルを検出し、最適なプロトコルを選択します。
    *   セッションエラー発生時には、プロトコルの再認証や代替プロトコルへの切り替えを試みるなど、自己回復メカニズムを備えています。
*   **`HttpClient.ts`**:
    *   `axios` をベースにしたHTTPクライアント。デバイスとのHTTP通信を抽象化します。
*   **`ConnectionManager.ts`, `SessionManager.ts`, `RequestManager.ts`, `ProtocolSelector.ts`**:
    *   接続、セッション、リクエスト、プロトコル選択をそれぞれ管理するクラス。`BaseDevice` でコンポジションとして利用され、各関心事を分離しています。
*   **`TapoCrypto.ts`**:
    *   RSAキーペア生成、AES暗号化/復号、ハッシュ計算など、通信に必要な暗号化処理を静的メソッドとして提供します。
    *   **RSAパディング方式の自動選択機能**を搭載し、OAEP (SHA1)パディング（モダン・高セキュリティ）を優先し、PKCS#1 v1.5パディング（レガシー互換性）にフォールバックします。

### 3.5. ユーティリティレイヤー

*   **`ErrorClassifier.ts`**:
    *   Tapoデバイスから返される様々なエラーメッセージを標準化されたエラータイプ（`SESSION_EXPIRED`, `DEVICE_BUSY`など）に分類します。
    *   エラーがリトライ可能かどうかを判断し、推奨される対応策を提供します。
*   **`RetryUtils.ts` (`TapoRetryHandler`)**:
    *   デバイス操作の信頼性を向上させるためのリトライ処理を実装します。
    *   指数バックオフ、線形バックオフなどのリトライ戦略をサポートします。
    *   `ErrorClassifier` と連携し、リトライ可能なエラーの場合にのみ再試行します。

### 3.6. 型定義レイヤー (`/types`)

*   ライブラリ全体で使用されるTypeScriptの型定義を集約しています。
*   `TapoDeviceInfo`, `TapoApiRequest`, `BulbCapabilities` など、デバイス情報、APIリクエスト/レスポンス、デバイス機能に関する型を定義し、コードの堅牢性と一貫性を高めています。
*   `device-types.ts` では、サポートされるデバイスモデルとそのカテゴリ（`PLUG`, `BULB`）を定義しています。

## 4. 通信プロトコル

Tapoデバイスは、主に2つのローカル通信プロトコルを使用します。

1.  **Secure Passthrough (旧プロトコル):**
    *   RSAとAESを組み合わせた暗号化方式。
    *   比較的古いファームウェアのデバイスで使用されます。
    *   RSAパディング方式: OAEP (SHA1) → PKCS#1 v1.5 フォールバック
    *   `TapoAuth.ts` で実装されています。

2.  **KLAP (Kepler Local Access Protocol) (新プロトコル):**
    *   より複雑なハンドシェイクとキー導出ロジックを持つプロトコル。
    *   最近のデバイスやファームウェアで標準的に使用されます。
    *   セッション管理が厳格で、ビジーエラーが発生しやすい傾向があります。
    *   **KLAP V1とV2の2つのバージョンが存在し、自動判別機能により適切なバージョンを選択します。**
    *   `KlapAuth.ts` で実装されています。

### 4.1. KLAP V1/V2の詳細仕様

| 項目 | KLAP V1 (Legacy) | KLAP V2 (Modern) |
|------|------------------|------------------|
| **ハンドシェイク** | 単一ステップ (`/app/handshake`) | 2ステップ (`/app/handshake1` → `/app/handshake2`) |
| **リクエスト** | `/app/klap` | `/app/request` |
| **シーケンス番号** | URLパラメータなし | `?seq=N` パラメータ付き |
| **RSAパディング** | PKCS#1 v1.5 (レガシー) | OAEP (SHA1) (モダン) |
| **互換性** | 古いファームウェア | 新しいファームウェア |
| **セキュリティ** | 標準 | より強固 |

### 4.2. プロトコル自動選択ロジック

本ライブラリは以下の優先順位でプロトコルを試行し、最適なプロトコルを自動選択します：

1. **KLAP V2** (最優先) - 最新のファームウェア向け
2. **KLAP V1** (フォールバック) - レガシーファームウェア向け
3. **Secure Passthrough** (最終フォールバック) - 非常に古いデバイス向け

プロトコル判別は以下のエラーパターンに基づいて行われます：
- **404/405エラー**: エンドポイントが存在しない場合に下位プロトコルへフォールバック
- **接続エラー**: ネットワーク問題のためフォールバックは行わない
- **認証エラー**: 詳細なトラブルシューティング情報を提供

## 5. 設計上の決定事項

### 5.1. アーキテクチャ設計原則

*   **コンポジション over 継承:** `BaseDevice` が各種マネージャやコントローラをコンポジションとして保持することで、柔軟性とテストの容易性を高めています。
*   **関心の分離:** 認証、リクエスト管理、機能別ロジックなどを明確に分離することで、各コンポーネントの独立性を保ち、保守性を向上させています。
*   **DeviceFactoryによるインスタンス生成の抽象化:** `DeviceFactory` がデバイスの型判別とインスタンス生成を担うことで、ユーザーはデバイスモデルを意識することなく、統一されたインターフェースでデバイスを操作できます。

### 5.2. プロトコル対応戦略

*   **多層プロトコル自動検出:** KLAP V2 → KLAP V1 → Secure Passthrough の順序で自動フォールバックすることで、最新デバイスから古いデバイスまで幅広く対応しています。
*   **インテリジェントなエラー分類:** プロトコルエラー（404/405）と接続エラー（ECONNREFUSED/ETIMEDOUT）を区別し、適切なフォールバック戦略を適用します。
*   **RSA暗号化の互換性確保:** OAEP (SHA1) パディングを優先し、PKCS#1 v1.5 パディングにフォールバックすることで、セキュリティと互換性を両立させています。

### 5.3. 信頼性・可用性の向上

*   **積極的なエラーハンドリングとリトライ:** `ErrorClassifier` と `TapoRetryHandler` を導入し、通信の不安定さやデバイスのビジー状態に起因する一時的なエラーから自動的に回復する仕組みを構築しています。
*   **詳細なデバッグログ:** プロトコル選択過程、認証フロー、エラー原因を詳細にログ出力し、トラブルシューティングを容易にしています。
*   **プロトコルバージョン情報の保持:** セッション情報にKLAPバージョン（V1/V2）を記録し、適切なエンドポイントとパラメータを選択できるようにしています。

### 5.4. 開発者エクスペリエンス

*   **透過的なプロトコル切り替え:** `UnifiedTapoProtocol` により、開発者はプロトコルの違いを意識することなく、シームレスにデバイスを操作できます。
*   **具体的なエラーガイダンス:** -1010エラーなど一般的な問題に対して、具体的なトラブルシューティング手順を提供しています。
*   **型安全性の確保:** TypeScriptの型システムを活用し、コンパイル時のエラー検出と開発時の補完機能を提供しています。

## 6. 実装完了状況

### 6.1. プロトコル対応状況

| プロトコル | バージョン | 実装状況 | 主な機能 |
|-----------|-----------|---------|---------|
| **Secure Passthrough** | - | ✅ 完了 | RSA+AES暗号化、レガシーデバイス対応 |
| **KLAP** | V1 (Legacy) | ✅ 完了 | 単一ハンドシェイク、レガシーファームウェア対応 |
| **KLAP** | V2 (Modern) | ✅ 完了 | 2段階ハンドシェイク、モダンファームウェア対応 |

### 6.2. 自動判別・フォールバック機能

| 機能 | 実装状況 | 説明 |
|------|---------|------|
| **プロトコル自動検出** | ✅ 完了 | KLAP V2 → V1 → Secure Passthrough の順序で試行 |
| **エラー分類システム** | ✅ 完了 | プロトコルエラーと接続エラーの区別 |
| **インテリジェントフォールバック** | ✅ 完了 | 404/405エラー時のみ下位プロトコルに移行 |
| **詳細ログ出力** | ✅ 完了 | デバッグ用の詳細な実行ログ |

### 6.3. セキュリティ機能

| 機能 | 実装状況 | 説明 |
|------|---------|------|
| **RSA自動パディング選択** | ✅ 完了 | OAEP (SHA1) → PKCS#1 v1.5 フォールバック |
| **AES-128-CBC暗号化** | ✅ 完了 | KLAP V1/V2共通の対称暗号化 |
| **セッション管理** | ✅ 完了 | バージョン情報を含むセッション状態管理 |
| **署名検証** | ✅ 完了 | KLAP リクエストの署名・検証機能 |

### 6.4. エラーハンドリング・診断機能

| 機能 | 実装状況 | 説明 |
|------|---------|------|
| **エラー分類システム** | ✅ 完了 | 標準化されたエラータイプ分類 |
| **自動リトライ機能** | ✅ 完了 | 指数バックオフによるインテリジェントリトライ |
| **詳細エラーガイダンス** | ✅ 完了 | -1010エラー等の具体的解決策提示 |
| **トラブルシューティング支援** | ✅ 完了 | デバッグログとエラー原因特定機能 |

### 6.5. デバイス互換性

現在の実装により、以下のデバイス範囲をサポート：

- **最新デバイス**: KLAP V2対応ファームウェア
- **中間デバイス**: KLAP V1対応ファームウェア  
- **レガシーデバイス**: Secure Passthrough専用
- **ハイブリッドサポート**: 複数プロトコル対応デバイス

この多層アプローチにより、市場に流通している幅広いTapoデバイスに対応しています。

